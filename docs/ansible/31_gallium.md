---
priority: 431
---

# üí° Gallium

Ansible-osuus eroaa Bash, PowerShell ja Python osuuksista siten, ett√§ valmista koodia tarjoillaan merkitt√§v√§sti aiempaa v√§hemm√§n. T√§m√§ osio on kurssin loppusilaus, jossa yhdistell√§√§n Bash ja Python -osuuksissa opittua Ansibleen. PowerShell hyl√§t√§√§n toistaiseksi, koska Ansible Control Noden tulee olla Unix-pohjainen, ja Bash on valmiina saatavilla.

Gallium-osiossa tehd√§√§n minimum viable product. T√§m√§ tehd√§√§n muutamassa vaiheessa.

| #   | Vaihe                | Ty√∂kalu         | Tavoite                                                 |
| --- | -------------------- | --------------- | ------------------------------------------------------- |
| 1   | venv                 | uv + Python     | Eristet√§√§n projektin riippuvuudet OS-tason Pythonista   |
| 2   | Ansible              | uv              | Asennetaan Ansible Core                                 |
| 3   | Virtual Machines     | Bash, Multipass | Luodaan kaksi managed nodea                             |
| 4   | Inventory Generation | Python script   | Luodaan Multipass-komennon outputista Ansible Inventory |
| 5   | Playbook             | VS Code         | Luodaan Hello World -tason Playbook                     |
| 6   | Test Run             | Ansible         | Ajetaan Playbook                                        |

Kuhunkin osioon on oma t√§rppins√§ alla. Lopulta sivun pohjalla on teht√§vi√§, jotka sis√§lt√§v√§t n√§m√§ vaiheet.

## T√§rpit

### 1Ô∏è‚É£ Venv

K√§yt√§mme Pythonin paketin- ja projektinhallintaan ty√∂kalua nimelt√§√§n [uv](https://docs.astral.sh/uv/).Onko se asennettuna jo Python-osion tiimoilta? Jos ei, asenna se. Se asentuu yhdell√§ komennolla, joka l√∂ytyy [uv](https://docs.astral.sh/uv/) sivulta.

Voit luoda uuden *Application* tyypin projektin alla n√§kyvill√§ k√§skyill√§. Huomaa, ett√§ projekti luodaan siihen hakemistoon, miss√§ olet nyt. Varmista, ett√§ olet oikeassa hakemistossa, kuten `$PROJECT_ROOT/ansible/`. Huomaa, ett√§ teemme applikaation nimelt√§√§n `ansible-managed-node`. T√§m√§ siksi, ett√§ haluamme v√§ltell√§ p√§√§llek√§isyytt√§ pelk√§n `ansible`-nimisen projektin kanssa. Muutoin `import` voi menn√§ pieleen tietyiss√§ tilanteissa.

```bash
# Install a new uv-managed Python
uv python install 3.12

# Pin this directory to use the installed Python (.python-version)
uv python pin 3.12

# Create a new uv-managed Python project
uv init --name "ansible-managed-node" --bare --app .
```

Voit kokeilla REPL:i√§ n√§in:

```console
$ uv run python
Creating virtual environment at: .venv
Python 3.12 (...) [...]
Type "help" for more information.
>>>
```

!!! warning "Law of UV"

    Huomaa, ett√§ `uv` hallinnoi Pythonia.
    
    1. √Ñl√§ pid√§ muita Pythoneita.
    2. Jos ajat Pythonia, k√§sky alkaa `uv run <komento>`.
    3. Jos asennat paketteja, k√§yt√§ `uv add <paketti>`.

    Unohda system-level Python eli `/bin/python3`. Siihen ei ole asennettu eik√§ siihen aiota asentaa ansiblea tai muita riippuvuuksia, joita *t√§m√§ applikaatio* sattuu tarvitsemaan.


### 2Ô∏è‚É£ Ansible

Nyt voimme asentaa Ansible Coren ==t√§h√§n meid√§n luomaamme applikaatioon==. Ei siis system-wide Pythoniin. √Ñl√§ sovella omia k√§skyj√§ teko√§lyn hallusinaatioiden perusteella. Lue mieluummin alla oleva t√§rppi.

```bash
uv add ansible-core
```

### 3Ô∏è‚É£ Virtual Machines

Voit luoda virtuaalikoneita Multipass-ty√∂kalulla. Nime√§ ne j√§rkev√§sti, kuten `ansible-1` ja `ansible-2`. Voit k√§ytt√§√§ alla olevia komentoja.

```bash
# Create 1 and 2
multipass launch --name ansible-1
multipass launch --name ansible-2
```

Kun my√∂hemmin haluat tuhota koneet, aja komennot:

```bash
multipass delete ansible-1
multipass delete ansible-2
multipass purge
```

Olisikohan t√§ss√§ kenties j√§rkev√§√§ k√§ytt√§√§ skriptej√§ `create-vms.sh` ja `destroy-vms.sh`? No olisi! Tee t√§m√§ skriptin√§.

### 4Ô∏è‚É£ Inventory Generation

Ansiblea varten tarvitsemme joko koneiden hostnamet tai IP-osoitteen Inventory-ty√∂kaluun. P√∂ller√∂n ratkaisu olisi aina k√§yd√§ k√§sin korvaamassa IP-osoitteet kun koneet luodaan uusiksi. T√§m√§ ei ole kovin skaalautuva ratkaisu. Sen sijaan voimme luoda skriptin, joka luo meille Inventoryn automaattisesti. Jotta t√§m√§ on mahdollista, tarvitset koneiden tiedot koneluettavassa muodossa, ja t√§m√§ onnistuu Multipassin avulla.

```bash
multipass list --format json
```

Mik√§ parempaa, voimme lopulta luoda Python-skriptin, joka lukee t√§m√§n outputin ja kirjoittaa sen tiedostoon `config/inventory/hosts.ini`. Lis√§t√§√§n kumpikin kone groupiin `multipass`, ja luodaan kummallekin oma ryhm√§ns√§: `first` ja `second`. T√§m√§ siksi, ett√§ voimme jatkossa kohdentaa k√§skyj√§ vain yhteen virtuaalikoneeseen helposti. Meill√§ ei ole DNS-osoitteita hallittuina, emmek√§ halua joutua kirjoittamaan IP-osoitteita, koska ne vaihtuvat joka kerta kun koneet tuhotaan ja luodaan uusiksi. Skripti√§ voisi k√§ytt√§√§ k√§sin n√§in:

```console
$ multipass list --format json | uv run scripts/multipass-to-inv.py
[INFO] Adding 192.168.64.41 to inventory
[INFO] Adding 192.168.64.42 to inventory
[INFO] Inventory written to config/inventory/hosts.ini

$ cat config/inventory/hosts.ini 
[multipass]
192.168.64.41
192.168.64.42

[first]
192.168.64.41

[second]
192.168.64.42
```

Yll√§ oleva komento olisi hyv√§ lis√§t√§ aiemmin luomaasi `create-vms`-skriptiin, eik√∂ vain? N√§in inventorio ei voi vahingossa unohtua tilaan, jossa se ei ole ajan tasalla.

??? tip "Opettajan skripti"

    Voit k√§ytt√§√§ t√§m√§n kaltaista skripti√§. Tunnista puuttuvat riippuvuudet ja lis√§√§ ne `uv add`-komennolla.

    ```python
    import sys

    from pydantic import BaseModel
    from ipaddress import IPv4Address
    from pathlib import Path

    TARGET_FILE = Path("config/inventory/hosts.ini")

    class VMInfo(BaseModel):
        ipv4: list[IPv4Address]
        name: str
        release: str
        state: str

    class VMList(BaseModel):
        list: list[VMInfo]

    def read_raw_json_from_stdin() -> str:
        if sys.stdin.isatty():
            print("No input string given", file=sys.stderr)
            sys.exit(1)
        
        return "".join([line.strip() for line in sys.stdin])

    def vmlist_to_ini(vm_list: VMList, ini_file) -> str:
        ini_file.parent.mkdir(parents=True, exist_ok=True)

        with ini_file.open("w") as f:
            f.write("[multipass]\n")
            for vm in vm_list.list:
                ip = vm.ipv4[0].exploded
                print(f"[INFO] Adding {ip} to inventory")
                f.write(f"{ip}\n")

            f.write("\n[first]\n")
            f.write(vm_list.list[0].ipv4[0].exploded)
            f.write("\n")

            f.write("\n[second]\n")
            f.write(vm_list.list[1].ipv4[0].exploded)

    if __name__ == "__main__":
        raw_json = read_raw_json_from_stdin()
        vm_list = VMList.model_validate_json(raw_json)
        vmlist_to_ini(vm_list, TARGET_FILE)
        print(f"[INFO] Inventory written to {TARGET_FILE}")
    ```

### 5Ô∏è‚É£ Playbook

Luo yksinkertainen Playbook, joka vain tulostaa `Hello, World!`. T√§m√§ on hyv√§ tapa varmistaa, ett√§ Ansible toimii ja ett√§ koneet ovat saavutettavissa. Voit k√§ytt√§√§ pohjana [Ansible Community Docs: Creating a playbook](https://docs.ansible.com/ansible/latest/getting_started/get_started_playbook.html) ohjeen esimerkki√§.

### 6Ô∏è‚É£ Test Run Erehdys ‚õî



!!! bug

    Nyt on tuikata Playbook k√§yntiin, ottaa et√§isyytt√§ ja ihailla k√§sien ty√∂t√§. Kuten aiemmasta Creating a Playbook -ohjeesta tied√§t, komento on:

    ```
    $ uv run ansible-playbook -i configs/inventory/hosts.ini configs/playbooks/hello.yml
    uv run ansible-playbook -i config/inventory/hosts.ini config/playbooks/hello-world.yml 

    PLAY [Hello World] 
    fatal: [192.168.64.42]: UNREACHABLE! => 
    {
        "changed": false, 
        "msg": "...myuser@192.168.64.42: Permission denied (publickey).", 
        "unreachable": true
    }
    ```

    Uh oh! ==Eih√§n homma toimi laisinkaan==, mutta t√§m√§ on ihan odotettua. Kuinka me voisimme saada SSH-yhteyden hostiin, johon emme ole lis√§nneet meid√§n julkista avainta? Lis√§ksi, yritimme yhdist√§√§ k√§ytt√§j√§ll√§ `myuser`, joka on *host-koneen* k√§ytt√§j√§nimi. 
    
    Korjataan t√§m√§ tilanne tasan kerran k√§sin oppimisen vuoksi. Ensi luvussa automatisoimme t√§m√§n.

### 6Ô∏è‚É£ Test Run Korjaus ‚úÖ

Saat lis√§tty√§ avaimen n√§in:

```bash
# Copy our public key to the remote hosts
multipass transfer ~/.ssh/id_ed25519.pub ansible-1:/tmp/id_ed25519.pub
multipass transfer ~/.ssh/id_ed25519.pub ansible-2:/tmp/id_ed25519.pub

# Append the public key to authorized_keys in /home/ubuntu/.ssh
multipass exec ansible-1 -- bash -c "cat /tmp/id_ed25519.pub >> ~/.ssh/authorized_keys"
multipass exec ansible-2 -- bash -c "cat /tmp/id_ed25519.pub >> ~/.ssh/authorized_keys"

# Disable SSH host key checking. This means the 
# "Are you sure you want to continue connecting (yes/no/[fingerprint])?" prompt is not shown.
# and the host is blindly trusted.
export ANSIBLE_HOST_KEY_CHECKING=False

# Run the playbook using the ubuntu user
uv run ansible-playbook -i config/inventory/hosts.ini config/playbooks/hello-world.yml -u ubuntu
```

Tulosteen pit√§isi olla jotakuinkin:

```
PLAY [Hello World] *********************

TASK [Gathering Facts] *********************
ok: [192.168.64.45]
ok: [192.168.64.44]

TASK [Print Hello World] *********************
ok: [192.168.64.45] => {
    "msg": "Hello, World!"
}
ok: [192.168.64.44] => {
    "msg": "Hello, World!"
}

PLAY RECAP *********************
192.168.64.44              : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
192.168.64.45              : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

## Teht√§v√§t

??? question "Teht√§v√§: Ansible Devausymp√§rist√∂"

    Luo yll√§ olevien t√§rppien avulla devausymp√§rist√∂ hakemistoon `ansible/`. Projektisi juuren tulisi n√§ytt√§√§ siis lopulta t√§lt√§:

    ```
    johnanderton
    ‚îú‚îÄ‚îÄ README.md
    ‚îú‚îÄ‚îÄ ansible/
    ‚îú‚îÄ‚îÄ bash/
    ‚îú‚îÄ‚îÄ pwsh/
    ‚îî‚îÄ‚îÄ python/
    ```

    Jos tarkastelemme vain `ansible/`-hakemistoa, sen tulisi n√§ytt√§√§ t√§lt√§:

    ```
    ansible
    ‚îú‚îÄ‚îÄ .python-version
    ‚îú‚îÄ‚îÄ .venv
    ‚îÇ   ‚îú‚îÄ‚îÄ .gitignore
    ‚îÇ   ‚îî‚îÄ‚îÄ many.files.here
    ‚îú‚îÄ‚îÄ config
    ‚îÇ   ‚îú‚îÄ‚îÄ inventory
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hosts.ini
    ‚îÇ   ‚îî‚îÄ‚îÄ playbooks
    ‚îÇ       ‚îî‚îÄ‚îÄ hello-world.yml
    ‚îú‚îÄ‚îÄ pyproject.toml
    ‚îú‚îÄ‚îÄ scripts
    ‚îÇ   ‚îú‚îÄ‚îÄ create-vms.sh
    ‚îÇ   ‚îú‚îÄ‚îÄ destroy-vms.sh
    ‚îÇ   ‚îî‚îÄ‚îÄ multipass-to-inv.py
    ‚îî‚îÄ‚îÄ uv.lock
    ```

    Huomaa, ett√§ osa tiedostoista luodaan komentojen avulla, osa k√§sin. √Ñl√§ luo esimerkiksi `pyproject.toml` tai `uv.lock` tiedostoja k√§sin. K√§yt√§ `uv`-ty√∂kalua, kuten t√§rpeiss√§ on neuvottu.

    !!! note

        Tuotannossa hakemistorakenne olisi todenn√§k√∂isesti monimutkaisempi. [Ansible Docs: Sample Ansible setup](https://docs.ansible.com/ansible/latest/tips_tricks/sample_setup.html) antaa esimerkkej√§ siit√§, kuinka hakemistot voivat olla j√§rjestetty.

??? question "Teht√§v√§: Ansible Hello World"

    Toisinna yll√§ n√§kyv√§t vaiheet siten, ett√§ saat Ansiblen tulostamaan `Hello, World!` molemmille virtuaalikoneille. K√§yt√§ apunasi yll√§ olevia t√§rppej√§.

    !!! tip "Vihje: Playbook"

        Playbook n√§ytt√§√§ lopulta jotakuinkin t√§lt√§:

        ```yaml
        ---
        - name: Hello World
        hosts: multipass
        tasks:
            - name: Print Hello World
            ansible.builtin.debug:
                msg: "Hello, World!"
        ...
        ```
